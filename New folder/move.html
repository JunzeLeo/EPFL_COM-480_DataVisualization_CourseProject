<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<!--  -->
<script>

// set the dimensions and margins of the graph
var margin = {top: 10, right: 30, bottom: 30, left: 60},
    width = 460 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Adds the svg canvas
var	svg2 = d3.select("body")
	.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
	.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Add X axis
var x = d3.scaleLinear()
  .domain([0, 8])
  .range([ 0, width ]);
svg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x));
svg2.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x));


// Add Y axis
var y = d3.scaleLinear()
  .domain([0, 8])
  .range([ height, 0]);
svg.append("g")
  .call(d3.axisLeft(y));
svg2.append("g")
  .call(d3.axisLeft(y));



var greyR = 3;
var rScale = 5;
var frameRate = 500;
var minYear = 0;
var maxYear = 4;
// Highlight the specie that is hovered
var highlight = function(d){
  looping = false;
  selected_country = d.country

  d3.selectAll(".dot")
    .transition()
    .duration(200)
    .style("fill", "lightgrey")
    .attr("r", greyR)

  d3.selectAll("." + selected_country)
    .transition()
    .duration(200)
    .style("fill", "green")
    .attr("r", function (d) { return d.forest*rScale; })
}

// Highlight the specie that is hovered
var doNotHighlight = function(){
  looping = true;
  d3.selectAll(".dot")
    .transition()
    .duration(200)
    .attr("class", function (d) { return "dot " + d.country } )
    .attr("cx", function (d) { return x(d.urb); } )
    .attr("cy", function (d) { return y(d.temp); } )
    .attr("r", function (d) { return d.forest*rScale; })
    .style("fill", "green" )
}


var getCountry = function(d){
  selected_country = d.country
  d3.selectAll("." + selected_country)
    .transition()
    .duration(200)
    .style("fill", "green")
    .attr("r", function (d) { return d.forest*rScale; })
}



var looping = true
function loopData (){
  // d3.selectAll("svg > *").remove();

  var currentYear = minYear;
  var alldata = null;
  // Read the data
  d3.csv("data.csv", function(data) {
    console.log(currentYear)
    alldata = data
    data1 = data.filter(function(d) {return d.year == currentYear})
    // Add dots
    svg.append('g')
      .selectAll("circle")
      .data(data1)
      .enter()
      .append("circle")
        .attr("class", function (d) { return "dot " + d.country } )
        .attr("cx", function (d) { return x(d.urb); } )
        .attr("cy", function (d) { return y(d.temp); } )
        .attr("r", function (d) { return d.forest*0.1; })
        .style("fill", "green" )
      .on("mouseover", highlight)
      .on("mouseleave", doNotHighlight )
      .on("click", getCountry)
  })

  function updateGraph(){
    if(!looping){return;}
    currentYear += 1
    if(currentYear > maxYear){
      currentYear = 0
    }
    console.log(currentYear);

    data1 = alldata.filter(function(d) {return d.year == currentYear})
    svg.selectAll("circle")
        .data(data1)
        .transition()
        .duration(frameRate)
        // .delay(function(d, i) {return 1000} )
        .attr("cx", function (d) { return x(d.urb); } )
        .attr("cy", function (d) { return y(d.temp); } )
        .attr("r", function (d) { return d.forest*rScale; })

  }
  var interval = setInterval(updateGraph, frameRate);
  // setTimeout(function() {
  //     clearInterval(interval)
  // }, 500*10);
}

loopData()
</script>
